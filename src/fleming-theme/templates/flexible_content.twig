{% set supporting_content_starts_at_index = false %}
{% set in_collapsible = false %}
{% for content_block in flexible_content if not supporting_content_starts_at_index %}
  {% if content_block.acf_fc_layout == 'start_of_supporting_content' %}
    {% set supporting_content_starts_at_index = loop.index + 1 %}
  {% else %}
    {% if content_block.acf_fc_layout == 'section_title' %}
      {% if in_collapsible %}
        {% include 'flexible-content/collapsible-terminator.html' %}
        {% set in_collapsible = false %}
      {% endif %}
      {% if content_block.collapsible %}
        {% set in_collapsible = true %}
      {% endif %}
    {% endif %}
    {% include 'flexible-content/content-block.html' %}
  {% endif %}
{% endfor %}

{% if in_collapsible %}
  {% include 'flexible-content/collapsible-terminator.html' %}
  {% set in_collapsible = false %}
{% endif %}

{% if supporting_content_starts_at_index and supporting_content_starts_at_index <= flexible_content|length %}
  {% embed 'layout/supporting-content.html' %}
    {% block content %}
      {% for content_block in flexible_content %}
        {% if loop.index >= supporting_content_starts_at_index %}
          {% if content_block.acf_fc_layout == 'section_title' %}
            {% if in_collapsible %}
              {% include 'flexible-content/collapsible-terminator.html' %}
              {% set in_collapsible = false %}
            {% endif %}
            {% if content_block.collapsible %}
              {% set in_collapsible = true %}
            {% endif %}
          {% endif %}
          {% include 'flexible-content/content-block.html' %}
        {% endif %}
      {% endfor %}
    {% endblock %}
  {% endembed %}
{% endif %}

{% if in_collapsible %}
  {% include 'flexible-content/collapsible-terminator.html' %}
  {% set in_collapsible = false %}
{% endif %}