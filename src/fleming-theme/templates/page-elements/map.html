{% set map_id = 'map-'~random() %}

<svg xmlns="http://www.w3.org/2000/svg" style="width:0;height:0;position:absolute;overflow:hidden;">
  <defs>
    {% for region in map_config.regions %}
      <pattern id="subtle-hatched-{{ region.colourScheme }}"
               x="0" y="0" width="2" height="2"
               patternUnits="userSpaceOnUse"
               patternTransform="rotate(45)">
        <path d="M1 0 V 2" stroke="darkgrey" stroke-width="1.5"/>
      </pattern>
    {% endfor %}
  </defs>
</svg>

<div class="map-container {{ map_is_interactive ? 'interactive' }}" aria-hidden="true">
  <div class="container alignment-helper buttons">
    <button id="{{ map_id }}-zoom-in" class="zoom-in square-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="6 6 20 20">
        <path d="M14 6 H 18 V 14 H 26 V 18 H 18 V 26 H 14 V 18 H 6 V 14 H 14 Z"/>
      </svg>
    </button>
    <button id="{{ map_id }}-zoom-out" class="zoom-out square-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="6 6 20 20">
        <path d="M6 14 H 26 V 18 H 6 Z"/>
      </svg>
    </button>
  </div>
  <div class="map" id="{{ map_id }}"></div>
</div>

<script type="text/javascript">
    //<![CDATA[
    var mapConfig = {{ map_config|json_encode|raw }};
    {% set initialRegionSlug = map_config.regions[map_config.currentRegion].countries is not empty ? map_config.currentRegion : 'all' %}
    var highlightedRegion = '{{ initialRegionSlug }}';
    var focusedRegion = '{{ initialRegionSlug }}';

    function getCountryFillMap() {
        var fillMap = {};
        $.each(mapConfig.countries, function (code, country) {
            var region = mapConfig.regions[country.region];
            fillMap[code] = region.colourScheme;
        });
        return fillMap;
    }

    function getCountryFillOpacityMap() {
        var fillOpacityMap = {};
        $.each(mapConfig.countries, function (code, country) {
            fillOpacityMap[code] = (country.isPartner ? '0.5' : '1');
        });
        return fillOpacityMap;
    }

    function getCountryStyleMap() {
        var styleMap = {};
        $.each(mapConfig.countries, function (code, country) {
            styleMap[code] = 'cursor: pointer';
        });
        return styleMap;
    }

    function getCountryClassMap() {
        var classMap = {};
        $.each(mapConfig.countries, function (code, country) {
            var region = mapConfig.regions[country.region];
            classMap[code]
                = 'jvectormap-region jvectormap-element '
                + (country.isPartner ? 'partner ' : '')
                + region.colourScheme
                + ((highlightedRegion === 'all') || (highlightedRegion === country.region) ? '' : ' not-highlighted');
        });
        return classMap;
    }

    var map;
    $(function () {
        $('.map-container').show();
        map = $('#{{ map_id }}').vectorMap({
            map: 'world_mill',
            backgroundColor: '#e5e5e5',
            regionStyle: {
                initial: {
                    fill: 'white',
                    "fill-opacity": 1,
                    stroke: 'none',
                    "stroke-width": 0,
                    "stroke-opacity": 1
                },
                hover: {
                    cursor: 'normal'
                }
            },
            focusOn: {
                regions: mapConfig.regions[focusedRegion].countries
            },
            series: {
                regions: [
                    {attribute: 'class', values: getCountryClassMap()},
                    {attribute: 'fill', values: getCountryFillMap()},
                    {attribute: 'fill-opacity', values: getCountryFillOpacityMap()},
                    {attribute: 'style', values: getCountryStyleMap()},
                ]
            },
            zoomOnScroll: false,
            panOnDrag: {{ map_is_interactive ? 'true': 'false' }},
            zoomMax: 10,
            onRegionTipShow: function (e, tip, code) {
                var country = mapConfig.countries[code];
                if (country) {
                    tip.html(country.name);
                } else {
                    e.preventDefault();
                }
            },
            onRegionClick: function (e, code) {
                var country = mapConfig.countries[code];
                if (country) {
                    window.location.href = country.URL;
                }
            }
        }).vectorMap('get', 'mapObject');

        $('#{{ map_id }}-zoom-in').click(
            function () {
                map.setScale(map.scale * map.params.zoomStep, map.width / 2, map.height / 2, !1, map.params.zoomAnimate)
            }
        );
        $('#{{ map_id }}-zoom-out').click(
            function () {
                map.setScale(map.scale / map.params.zoomStep, map.width / 2, map.height / 2, !1, map.params.zoomAnimate)
            }
        );

    });

    function refocusMap() {
        if (map !== undefined && focusedRegion !== undefined) {
            map.updateSize();
            map.setFocus({
                regions: mapConfig.regions[focusedRegion].countries
            });
        }
    }

    function focusMapOn(region) {
        focusedRegion = region;
        if (mapConfig.regions[region] === undefined || mapConfig.regions[region].countries.length === 0) {
            focusedRegion = 'all';
        } else {
            focusedRegion = region;
        }
        refocusMap();

    }

    $(window).resize(function () {
        refocusMap();
    });
    //]]>
</script>