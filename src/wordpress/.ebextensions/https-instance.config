packages:
  yum:
    mod24_ssl : []

files:
  /etc/httpd/conf.d/ssl.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule ssl_module modules/mod_ssl.so
      Listen 443
      <VirtualHost *:443>
        <Proxy *>
          Order deny,allow
          Allow from all
        </Proxy>

        SSLEngine             on
        SSLCertificateFile    "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        SSLCertificateChainFile "/etc/pki/tls/certs/fullchain.crt"
        SSLCipherSuite        EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
        SSLProtocol           All -SSLv2 -SSLv3
        SSLHonorCipherOrder   On
        SSLSessionTickets     Off

        Header always set X-Frame-Options DENY
        Header always set X-Content-Type-Options nosniff

        ProxyPass / http://localhost:80/ retry=0
        ProxyPassReverse / http://localhost:80/
        ProxyPreserveHost on
        RequestHeader set X-Forwarded-Proto "https" early

      </VirtualHost>


  /opt/certbot/eb-certbot.sh:
    mode: "000500"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -ex
      source /opt/elasticbeanstalk/support/envvars

      EMAIL="${EMAIL:-Team-FlemingFundSupport@softwire.com}"
      PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/opt/aws/bin:/home/ec2-user/.local/bin:/home/ec2-user/bin

      if [ -z "$DOMAIN" ]; then
          echo "No domain environment variable"
          exit 1
      fi

      mkdir -p /opt/certbot

      if [ ! -f /opt/certbot/certbot-auto ]; then
          wget https://dl.eff.org/certbot-auto -O /opt/certbot/certbot-auto
          chmod a+x /opt/certbot/certbot-auto
      fi

      /opt/certbot/certbot-auto certonly --debug --non-interactive --email $EMAIL --webroot --webroot-path /var/app/current --agree-tos --domain $DOMAIN --keep-until-expiring

      cp /etc/letsencrypt/live/${DOMAIN}/cert.pem /etc/pki/tls/certs/server.crt
      cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /etc/pki/tls/certs/fullchain.crt
      cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /etc/pki/tls/certs/server.key

      apachectl graceful


  /etc/cron.daily/eb-certbot.sh:
    mode: "000500"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /opt/certbot/eb-certbot.sh 2>&1 | tee -a /opt/certbot/certbot-cron.log


container_commands:
  10_certbot:
    command: "/opt/certbot/eb-certbot.sh 2>&1 | tee -a /opt/certbot/certbot.log"
